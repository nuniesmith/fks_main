name: Weekly Development Report

on:
  schedule:
    # Run every Friday at 5 PM UTC
    - cron: '0 17 * * 5'
  workflow_dispatch:

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for commit analysis
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pytest pytest-cov
      
      - name: Get commit statistics
        id: commits
        run: |
          WEEK_AGO=$(date -d '7 days ago' +%Y-%m-%d)
          COMMIT_COUNT=$(git log --since="$WEEK_AGO" --oneline | wc -l)
          CONTRIBUTORS=$(git log --since="$WEEK_AGO" --format='%an' | sort -u | wc -l)
          
          echo "count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
          echo "contributors=$CONTRIBUTORS" >> $GITHUB_OUTPUT
          
          echo "## Recent Commits" > commits.txt
          git log --since="$WEEK_AGO" --pretty=format:"- %s (%an)" >> commits.txt
      
      - name: Run tests
        id: tests
        continue-on-error: true
        run: |
          make test || true
          
          # Count passing/failing tests
          TOTAL_TESTS=$(pytest --collect-only -q 2>/dev/null | tail -1 | grep -oP '\d+(?= test)' || echo "0")
          echo "total=$TOTAL_TESTS" >> $GITHUB_OUTPUT
      
      - name: Check code coverage
        id: coverage
        continue-on-error: true
        run: |
          pytest --cov=src --cov-report=term-missing > coverage.txt 2>&1 || true
          COVERAGE=$(grep "TOTAL" coverage.txt | awk '{print $NF}' || echo "N/A")
          echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
      
      - name: Run linter
        id: lint
        continue-on-error: true
        run: |
          make lint 2>&1 | tee lint-output.txt || true
          LINT_ISSUES=$(grep -c "error\|warning" lint-output.txt || echo "0")
          echo "issues=$LINT_ISSUES" >> $GITHUB_OUTPUT
      
      - name: Generate weekly report
        run: |
          cat << EOF > weekly-report.md
          # ğŸ“Š FKS Weekly Development Report
          **Week ending:** $(date +%Y-%m-%d)
          
          ## ğŸ“ˆ Activity Summary
          - **Commits:** ${{ steps.commits.outputs.count }}
          - **Contributors:** ${{ steps.commits.outputs.contributors }}
          - **Total Tests:** ${{ steps.tests.outputs.total }}
          - **Code Coverage:** ${{ steps.coverage.outputs.percentage }}
          - **Lint Issues:** ${{ steps.lint.outputs.issues }}
          
          ## ğŸ”¨ Recent Changes
          $(cat commits.txt)
          
          ## ğŸ“‹ Current Status
          - **Services:** 8 microservices
          - **Health:** Check K8s dashboard for live status
          - **Documentation:** Updated in \`/docs\`
          
          ## ğŸ¯ Next Week Priorities
          - Continue Phase 1: Codebase cleanup
          - Enhance test coverage
          - Address lint issues
          
          ## ğŸ“ Notes
          - See \`docs/SRC_STRUCTURE_ANALYSIS.json\` for detailed code analysis
          - Review \`docs/CLEANUP_LOG.json\` for recent cleanup activities
          
          ---
          *This report was automatically generated by GitHub Actions*
          EOF
          
          cat weekly-report.md
      
      - name: Upload report
        uses: actions/upload-artifact@v3
        with:
          name: weekly-report
          path: |
            weekly-report.md
            commits.txt
            coverage.txt
          retention-days: 90
      
      - name: Post to discussions (optional)
        if: github.event_name == 'schedule'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('weekly-report.md', 'utf8');
            
            // This requires discussions to be enabled
            // Alternatively, could create an issue or send notification
            console.log('Weekly report generated:', report);

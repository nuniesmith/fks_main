---
# PostgreSQL Database with TimescaleDB
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-data
  namespace: fks-trading
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 100Gi

---
apiVersion: v1
kind: Service
metadata:
  name: db
  namespace: fks-trading
spec:
  type: ClusterIP
  ports:
    - port: 5432
      targetPort: 5432
  selector:
    app: postgres

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  namespace: fks-trading
spec:
  serviceName: db
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
      - name: postgres
        image: postgres:16
        ports:
        - containerPort: 5432
        env:
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: fks-secrets
              key: postgres-user
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: fks-secrets
              key: postgres-password
        - name: POSTGRES_DB
          value: "trading_db"
        - name: TZ
          value: "America/Toronto"
        volumeMounts:
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
        livenessProbe:
          exec:
            command:
            - pg_isready
            - -U
            - postgres
          initialDelaySeconds: 30
          periodSeconds: 10
      volumes:
      - name: postgres-data
        persistentVolumeClaim:
          claimName: postgres-data

---
# Redis
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: redis-data
  namespace: fks-trading
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi

---
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: fks-trading
spec:
  type: ClusterIP
  ports:
    - port: 6379
      targetPort: 6379
  selector:
    app: redis

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  namespace: fks-trading
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      - name: redis
        image: redis:7
        ports:
        - containerPort: 6379
        env:
        - name: TZ
          value: "America/Toronto"
        args:
        - redis-server
        - --appendonly
        - "yes"
        - --appendfsync
        - everysec
        - --maxmemory
        - 512mb
        - --maxmemory-policy
        - allkeys-lru
        volumeMounts:
        - name: redis-data
          mountPath: /data
        livenessProbe:
          exec:
            command:
            - redis-cli
            - ping
          initialDelaySeconds: 30
          periodSeconds: 10
      volumes:
      - name: redis-data
        persistentVolumeClaim:
          claimName: redis-data

---
# Django Web Service
apiVersion: v1
kind: Service
metadata:
  name: web
  namespace: fks-trading
  labels:
    app: fks-web
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 3001
      targetPort: 3001
  selector:
    app: fks-web

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fks-web
  namespace: fks-trading
spec:
  replicas: 2
  selector:
    matchLabels:
      app: fks-web
  template:
    metadata:
      labels:
        app: fks-web
    spec:
      initContainers:
      - name: migrate
        image: nuniesmith/fks:web-latest
        workingDir: /app
        command: ["/bin/sh", "-c"]
        args:
          - |
            cd /app/src
            python manage.py migrate || echo "Migration failed, but continuing"
            python manage.py collectstatic --noinput || echo "Collectstatic failed, but continuing"
        env:
        - name: DJANGO_SETTINGS_MODULE
          value: "config.settings"
        - name: PYTHONPATH
          value: "/app/src:/app/shared_src"
        - name: POSTGRES_DB
          value: "trading_db"
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: fks-secrets
              key: postgres-user
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: fks-secrets
              key: postgres-password
        - name: POSTGRES_HOST
          value: "db"
        - name: POSTGRES_PORT
          value: "5432"
        - name: REDIS_HOST
          value: "redis"
        - name: REDIS_PORT
          value: "6379"
        - name: REDIS_URL
          value: "redis://redis:6379/1"
      containers:
      - name: web
        image: nuniesmith/fks:web-latest
        imagePullPolicy: IfNotPresent
        workingDir: /app
        ports:
        - containerPort: 3001
        env:
        - name: TZ
          value: "America/Toronto"
        - name: PYTHONUNBUFFERED
          value: "1"
        - name: DJANGO_SETTINGS_MODULE
          value: "config.settings"
        - name: PYTHONPATH
          value: "/app/src:/app"
        - name: SERVICE_PORT
          value: "3001"
        - name: DJANGO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: fks-secrets
              key: django-secret-key
        - name: POSTGRES_DB
          value: "trading_db"
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: fks-secrets
              key: postgres-user
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: fks-secrets
              key: postgres-password
        - name: POSTGRES_HOST
          value: "db"
        - name: POSTGRES_PORT
          value: "5432"
        - name: REDIS_HOST
          value: "redis"
        - name: REDIS_PORT
          value: "6379"
        - name: REDIS_URL
          value: "redis://redis:6379/1"
        - name: CELERY_BROKER_URL
          value: "redis://redis:6379/0"
        - name: CELERY_RESULT_BACKEND
          value: "redis://redis:6379/0"
        - name: ALLOWED_HOSTS
          value: "*"
        - name: FKS_PORTFOLIO_URL
          value: "http://fks-portfolio:8012"
        # Override entrypoint to use uvicorn directly instead of python -m uvicorn
        command: ["/bin/bash", "-c"]
        args:
          - |
            set +e
            SERVICE_NAME=${SERVICE_NAME:-fks_web}
            SERVICE_PORT=${SERVICE_PORT:-3001}
            HOST=${HOST:-0.0.0.0}
            echo "Starting ${SERVICE_NAME} on ${HOST}:${SERVICE_PORT}"
            mkdir -p /app/staticfiles
            chmod 755 /app/staticfiles
            echo "Collecting static files..."
            cd /app
            # Skip collectstatic for now to focus on getting the server running
            echo "âš  Skipping static file collection for now"
            set -e
            # Start uvicorn - use uvicorn command directly with explicit PYTHONPATH
            cd /app
            export PYTHONPATH=/app/src:/app
            exec uvicorn src.config.asgi:application --host "${HOST}" --port "${SERVICE_PORT}" --no-access-log --log-level info
        livenessProbe:
          httpGet:
            path: /health
            port: 3001
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 5
        readinessProbe:
          httpGet:
            path: /health
            port: 3001
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5

---
# FKS API Service
apiVersion: v1
kind: Service
metadata:
  name: fks-api
  namespace: fks-trading
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 8001
      targetPort: 8001
  selector:
    app: fks-api

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fks-api
  namespace: fks-trading
spec:
  replicas: 2
  selector:
    matchLabels:
      app: fks-api
  template:
    metadata:
      labels:
        app: fks-api
    spec:
      containers:
      - name: api
        image: nuniesmith/fks:api-latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8001
        env:
        - name: SERVICE_NAME
          value: "fks_api"
        - name: SERVICE_PORT
          value: "8001"
        - name: POSTGRES_DB
          value: "trading_db"
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: fks-secrets
              key: postgres-user
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: fks-secrets
              key: postgres-password
        - name: POSTGRES_HOST
          value: "db"
        - name: REDIS_URL
          value: "redis://redis:6379/2"
        - name: APP_SERVICE_URL
          value: "http://fks-app:8002"
        - name: DATA_SERVICE_URL
          value: "http://fks-data:8003"
        livenessProbe:
          httpGet:
            path: /health
            port: 8001
          initialDelaySeconds: 30
          periodSeconds: 30

---
# FKS App Service
apiVersion: v1
kind: Service
metadata:
  name: fks-app
  namespace: fks-trading
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 8002
      targetPort: 8002
  selector:
    app: fks-app

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fks-app
  namespace: fks-trading
spec:
  replicas: 2
  selector:
    matchLabels:
      app: fks-app
  template:
    metadata:
      labels:
        app: fks-app
    spec:
      containers:
      - name: app
        image: nuniesmith/fks:app-latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8002
        env:
        - name: SERVICE_NAME
          value: "fks_app"
        - name: POSTGRES_DB
          value: "trading_db"
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: fks-secrets
              key: postgres-user
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: fks-secrets
              key: postgres-password
        - name: POSTGRES_HOST
          value: "db"
        - name: REDIS_URL
          value: "redis://redis:6379/5"
        - name: DATA_SERVICE_URL
          value: "http://fks-data:8003"
        - name: AI_SERVICE_URL
          value: "http://fks-ai:8007"
        livenessProbe:
          httpGet:
            path: /health
            port: 8002
          initialDelaySeconds: 30
          periodSeconds: 30

---
# FKS Data Service
apiVersion: v1
kind: Service
metadata:
  name: fks-data
  namespace: fks-trading
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 8003
      targetPort: 8003
  selector:
    app: fks-data

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fks-data
  namespace: fks-trading
spec:
  replicas: 2
  selector:
    matchLabels:
      app: fks-data
  template:
    metadata:
      labels:
        app: fks-data
    spec:
      containers:
      - name: data
        image: nuniesmith/fks:data-latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8003
        env:
        - name: SERVICE_NAME
          value: "fks_data"
        - name: SERVICE_PORT
          value: "8003"
        - name: POSTGRES_DB
          value: "trading_db"
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: fks-secrets
              key: postgres-user
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: fks-secrets
              key: postgres-password
        - name: POSTGRES_HOST
          value: "db"
        - name: REDIS_URL
          value: "redis://redis:6379/3"
        livenessProbe:
          httpGet:
            path: /health
            port: 8003
          initialDelaySeconds: 30
          periodSeconds: 30

---
# FKS AI Service
apiVersion: v1
kind: Service
metadata:
  name: fks-ai
  namespace: fks-trading
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 8007
      targetPort: 8007
  selector:
    app: fks-ai

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fks-ai
  namespace: fks-trading
spec:
  replicas: 1
  selector:
    matchLabels:
      app: fks-ai
  template:
    metadata:
      labels:
        app: fks-ai
    spec:
      containers:
      - name: ai
        image: nuniesmith/fks:ai-latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8007
        env:
        - name: SERVICE_NAME
          value: "fks_ai"
        - name: SERVICE_PORT
          value: "8007"
        - name: POSTGRES_DB
          value: "trading_db"
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: fks-secrets
              key: postgres-user
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: fks-secrets
              key: postgres-password
        - name: POSTGRES_HOST
          value: "db"
        - name: REDIS_URL
          value: "redis://redis:6379/6"
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: fks-secrets
              key: openai-api-key
              optional: true
        resources:
          requests:
            memory: "2Gi"
            cpu: "1000m"
          limits:
            memory: "4Gi"
            cpu: "2000m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8007
          initialDelaySeconds: 60
          periodSeconds: 30

---
# Celery Worker
apiVersion: apps/v1
kind: Deployment
metadata:
  name: celery-worker
  namespace: fks-trading
spec:
  replicas: 2
  selector:
    matchLabels:
      app: celery-worker
  template:
    metadata:
      labels:
        app: celery-worker
    spec:
      containers:
      - name: worker
        image: nuniesmith/fks:web-latest
        imagePullPolicy: IfNotPresent
        command: ["celery"]
        args:
          - -A
          - config
          - worker
          - --loglevel=info
          - --concurrency=4
        env:
        - name: DJANGO_SETTINGS_MODULE
          value: "src.django.settings"
        - name: PYTHONPATH
          value: "/app/src:/app/shared_src"
        - name: CELERY_BROKER_URL
          value: "redis://redis:6379/0"
        - name: CELERY_RESULT_BACKEND
          value: "redis://redis:6379/0"
        - name: POSTGRES_DB
          value: "trading_db"
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: fks-secrets
              key: postgres-user
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: fks-secrets
              key: postgres-password
        - name: POSTGRES_HOST
          value: "db"
        - name: REDIS_HOST
          value: "redis"
        - name: REDIS_PORT
          value: "6379"
        - name: REDIS_URL
          value: "redis://redis:6379/1"

---
# Celery Beat
apiVersion: apps/v1
kind: Deployment
metadata:
  name: celery-beat
  namespace: fks-trading
spec:
  replicas: 1
  selector:
    matchLabels:
      app: celery-beat
  template:
    metadata:
      labels:
        app: celery-beat
    spec:
      initContainers:
      - name: migrate
        image: nuniesmith/fks:web-latest
        imagePullPolicy: IfNotPresent
        command: ["/bin/sh", "-c"]
        args:
          - |
            cd /app/shared_src || cd /app
            python manage.py migrate django_celery_beat --noinput || echo "Migration failed, but continuing"
        env:
        - name: DJANGO_SETTINGS_MODULE
          value: "src.django.settings"
        - name: PYTHONPATH
          value: "/app/src:/app/shared_src"
        - name: POSTGRES_DB
          value: "trading_db"
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: fks-secrets
              key: postgres-user
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: fks-secrets
              key: postgres-password
        - name: POSTGRES_HOST
          value: "db"
      containers:
      - name: beat
        image: nuniesmith/fks:web-latest
        imagePullPolicy: IfNotPresent
        command: ["celery"]
        args:
          - -A
          - config
          - beat
          - --loglevel=info
          - --scheduler
          - django_celery_beat.schedulers:DatabaseScheduler
        env:
        - name: DJANGO_SETTINGS_MODULE
          value: "src.django.settings"
        - name: PYTHONPATH
          value: "/app/src:/app/shared_src"
        - name: CELERY_BROKER_URL
          value: "redis://redis:6379/0"
        - name: CELERY_RESULT_BACKEND
          value: "redis://redis:6379/0"
        - name: POSTGRES_DB
          value: "trading_db"
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: fks-secrets
              key: postgres-user
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: fks-secrets
              key: postgres-password
        - name: POSTGRES_HOST
          value: "db"
        - name: REDIS_HOST
          value: "redis"
        - name: REDIS_PORT
          value: "6379"

---
# Flower - Celery Monitoring
apiVersion: v1
kind: Service
metadata:
  name: flower
  namespace: fks-trading
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 5555
      targetPort: 5555
  selector:
    app: flower

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: flower
  namespace: fks-trading
spec:
  replicas: 1
  selector:
    matchLabels:
      app: flower
  template:
    metadata:
      labels:
        app: flower
    spec:
      containers:
      - name: flower
        image: nuniesmith/fks:web-latest
        imagePullPolicy: IfNotPresent
        command: ["celery"]
        args:
          - -A
          - config
          - flower
          - --port=5555
          - --broker=redis://redis:6379/0
        ports:
        - containerPort: 5555
        env:
        - name: DJANGO_SETTINGS_MODULE
          value: "src.django.settings"
        - name: PYTHONPATH
          value: "/app/src:/app/shared_src"
        - name: CELERY_BROKER_URL
          value: "redis://redis:6379/0"
        - name: CELERY_RESULT_BACKEND
          value: "redis://redis:6379/0"

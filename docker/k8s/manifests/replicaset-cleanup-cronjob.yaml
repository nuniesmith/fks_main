apiVersion: v1
kind: ConfigMap
metadata:
  name: replicaset-cleanup-script
  namespace: fks-trading
  labels:
    app: replicaset-cleanup
data:
  cleanup.sh: |
    #!/bin/bash
    # Clean up old replica sets with 0 replicas in fks-trading namespace
    
    set -e
    
    NAMESPACE="fks-trading"
    
    echo "=========================================="
    echo "Automated ReplicaSet Cleanup"
    echo "=========================================="
    echo "Timestamp: $(date)"
    echo ""
    
    # Get all replica sets with 0 replicas
    OLD_RS=$(kubectl get replicasets -n "$NAMESPACE" -o json 2>/dev/null | \
      jq -r '.items[] | select(.status.replicas == 0) | .metadata.name' 2>/dev/null || echo "")
    
    if [ -z "$OLD_RS" ]; then
      echo "✓ No old replica sets to clean up"
      exit 0
    fi
    
    COUNT=$(echo "$OLD_RS" | grep -v '^$' | wc -l)
    echo "Found $COUNT replica sets with 0 replicas"
    echo ""
    
    # Delete old replica sets
    DELETED=0
    echo "$OLD_RS" | while read -r rs; do
      if [ -n "$rs" ]; then
        echo "  Deleting $rs..."
        if kubectl delete replicaset "$rs" -n "$NAMESPACE" --ignore-not-found=true 2>/dev/null; then
          DELETED=$((DELETED + 1))
        fi
      fi
    done
    
    echo ""
    echo "✓ Cleanup complete!"
    echo ""
    echo "Remaining replica sets:"
    kubectl get replicasets -n "$NAMESPACE" --no-headers 2>/dev/null | wc -l || echo "0"
    echo ""
    echo "=========================================="

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: replicaset-cleanup
  namespace: fks-trading
  labels:
    app: replicaset-cleanup

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: replicaset-cleanup
  namespace: fks-trading
  labels:
    app: replicaset-cleanup
rules:
- apiGroups: ["apps"]
  resources: ["replicasets"]
  verbs: ["get", "list", "delete"]
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: replicaset-cleanup
  namespace: fks-trading
  labels:
    app: replicaset-cleanup
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: replicaset-cleanup
subjects:
- kind: ServiceAccount
  name: replicaset-cleanup
  namespace: fks-trading

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: replicaset-cleanup
  namespace: fks-trading
  labels:
    app: replicaset-cleanup
spec:
  # Run every Sunday at 2 AM
  schedule: "0 2 * * 0"
  # Keep last 3 successful jobs
  successfulJobsHistoryLimit: 3
  # Keep last 1 failed job for debugging
  failedJobsHistoryLimit: 1
  # Don't start new job if previous one is still running
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: replicaset-cleanup
        spec:
          serviceAccountName: replicaset-cleanup
          restartPolicy: OnFailure
          containers:
          - name: cleanup
            image: bitnami/kubectl:latest
            command:
            - /bin/bash
            - -c
            - |
              # Install jq if not available
              if ! command -v jq &> /dev/null; then
                echo "Installing jq..."
                apk add --no-cache jq 2>/dev/null || \
                apt-get update && apt-get install -y jq 2>/dev/null || \
                yum install -y jq 2>/dev/null || \
                echo "Warning: jq not available, using alternative method"
              fi
              
              # Load script from ConfigMap
              SCRIPT=$(kubectl get configmap replicaset-cleanup-script -n fks-trading -o jsonpath='{.data.cleanup\.sh}')
              echo "$SCRIPT" > /tmp/cleanup.sh
              chmod +x /tmp/cleanup.sh
              
              # Run cleanup script
              /tmp/cleanup.sh
            env:
            - name: NAMESPACE
              value: "fks-trading"
          # Optional: Add resource limits
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "128Mi"
              cpu: "100m"


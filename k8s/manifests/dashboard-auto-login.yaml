---
# Kubernetes Dashboard Auto-Login Configuration
# This creates a service account with cluster-admin permissions and generates a token

apiVersion: v1
kind: ServiceAccount
metadata:
  name: dashboard-admin
  namespace: kubernetes-dashboard
  labels:
    app: kubernetes-dashboard
    component: auto-login
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: dashboard-admin
  labels:
    app: kubernetes-dashboard
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: dashboard-admin
  namespace: kubernetes-dashboard
---
# ConfigMap with auto-login script
apiVersion: v1
kind: ConfigMap
metadata:
  name: dashboard-auto-login
  namespace: kubernetes-dashboard
  labels:
    app: kubernetes-dashboard
data:
  auto-login.js: |
    // Auto-login script for Kubernetes Dashboard
    // This script automatically fills in the token when the dashboard loads
    
    (function() {
      'use strict';
      
      // Wait for dashboard to load
      function waitForDashboard() {
        const loginForm = document.querySelector('form[action="/api/v1/login"]');
        const tokenInput = document.querySelector('input[type="text"][name="token"]');
        
        if (loginForm && tokenInput) {
          // Get token from localStorage or fetch from API
          const token = localStorage.getItem('k8s-dashboard-token') || 
                       getTokenFromURL() ||
                       prompt('Please enter your dashboard token:');
          
          if (token) {
            tokenInput.value = token;
            localStorage.setItem('k8s-dashboard-token', token);
            
            // Auto-submit after a short delay
            setTimeout(() => {
              loginForm.submit();
            }, 500);
          }
        } else {
          // Retry after 1 second
          setTimeout(waitForDashboard, 1000);
        }
      }
      
      // Get token from URL parameter
      function getTokenFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get('token');
      }
      
      // Start waiting when page loads
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDashboard);
      } else {
        waitForDashboard();
      }
    })();
  
  index.html: |
    <!DOCTYPE html>
    <html>
    <head>
      <title>Kubernetes Dashboard - Auto Login</title>
      <meta http-equiv="refresh" content="0;url=/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/?token={{TOKEN}}">
      <script>
        // Get token from query parameter or localStorage
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token') || localStorage.getItem('k8s-dashboard-token');
        
        if (token) {
          localStorage.setItem('k8s-dashboard-token', token);
          // Redirect to dashboard with token
          window.location.href = '/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/?token=' + token;
        } else {
          // Show token input form
          document.write(`
            <h1>Kubernetes Dashboard - Token Required</h1>
            <p>Please enter your dashboard token:</p>
            <input type="text" id="token-input" placeholder="Paste token here" style="width: 500px; padding: 10px;">
            <button onclick="login()">Login</button>
            <script>
              function login() {
                const token = document.getElementById('token-input').value;
                if (token) {
                  localStorage.setItem('k8s-dashboard-token', token);
                  window.location.href = '/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/?token=' + token;
                }
              }
            </script>
          `);
        }
      </script>
    </head>
    <body>
      <p>Redirecting to dashboard...</p>
    </body>
    </html>


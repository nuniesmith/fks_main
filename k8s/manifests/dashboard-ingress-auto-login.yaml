---
# Kubernetes Dashboard Ingress with Auto-Login
# This creates an ingress that automatically injects the token via query parameter

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: kubernetes-dashboard-ingress-auto
  namespace: kubernetes-dashboard
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
    nginx.ingress.kubernetes.io/rewrite-target: /$1
    nginx.ingress.kubernetes.io/configuration-snippet: |
      proxy_ssl_verify off;
spec:
  ingressClassName: nginx
  rules:
  - host: dashboard.fkstrading.xyz
    http:
      paths:
      - path: /(.*)
        pathType: Prefix
        backend:
          service:
            name: kubernetes-dashboard
            port:
              number: 443
  tls:
  - hosts:
    - dashboard.fkstrading.xyz
    secretName: dashboard-tls

---
# Service to generate and serve dashboard token
apiVersion: v1
kind: Service
metadata:
  name: dashboard-token-service
  namespace: kubernetes-dashboard
spec:
  type: ClusterIP
  ports:
    - port: 8080
      targetPort: 8080
  selector:
    app: dashboard-token-service

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dashboard-token-service
  namespace: kubernetes-dashboard
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dashboard-token-service
  template:
    metadata:
      labels:
        app: dashboard-token-service
    spec:
      serviceAccountName: dashboard-admin
      containers:
      - name: token-service
        image: nginx:alpine
        ports:
        - containerPort: 8080
        volumeMounts:
        - name: token-html
          mountPath: /usr/share/nginx/html
        - name: nginx-config
          mountPath: /etc/nginx/conf.d
      volumes:
      - name: token-html
        configMap:
          name: dashboard-token-html
      - name: nginx-config
        configMap:
          name: dashboard-nginx-config

---
# ConfigMap with auto-login HTML page
apiVersion: v1
kind: ConfigMap
metadata:
  name: dashboard-token-html
  namespace: kubernetes-dashboard
data:
  index.html: |
    <!DOCTYPE html>
    <html>
    <head>
      <title>Kubernetes Dashboard - Auto Login</title>
      <meta charset="UTF-8">
      <style>
        body {
          font-family: Arial, sans-serif;
          max-width: 800px;
          margin: 50px auto;
          padding: 20px;
          background: #f5f5f5;
        }
        .container {
          background: white;
          padding: 30px;
          border-radius: 8px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button {
          background: #1976d2;
          color: white;
          padding: 12px 24px;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 16px;
          margin: 10px 5px;
        }
        .button:hover {
          background: #1565c0;
        }
        .status {
          padding: 10px;
          margin: 10px 0;
          border-radius: 4px;
          background: #e3f2fd;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <h1>ðŸš€ Kubernetes Dashboard - Auto Login</h1>
        <div class="status" id="status">Loading token...</div>
        <button class="button" onclick="openDashboard()">Open Dashboard</button>
        <button class="button" onclick="copyToken()">Copy Token</button>
      </div>
      <script>
        let dashboardToken = '';
        
        // Fetch token from API
        async function fetchToken() {
          try {
            const response = await fetch('/api/token');
            if (response.ok) {
              const data = await response.json();
              dashboardToken = data.token;
              document.getElementById('status').textContent = 'Token loaded successfully!';
              document.getElementById('status').style.background = '#c8e6c9';
              return true;
            }
          } catch (e) {
            console.error('Error fetching token:', e);
          }
          document.getElementById('status').textContent = 'Could not fetch token automatically. Please use kubectl to get token.';
          document.getElementById('status').style.background = '#ffcdd2';
          return false;
        }
        
        // Open dashboard with token
        function openDashboard() {
          if (!dashboardToken) {
            alert('Token not loaded. Please copy token manually.');
            return;
          }
          const dashboardUrl = `https://dashboard.fkstrading.xyz/#/login?token=${encodeURIComponent(dashboardToken)}`;
          window.open(dashboardUrl, '_blank');
        }
        
        // Copy token to clipboard
        function copyToken() {
          if (!dashboardToken) {
            alert('Token not loaded.');
            return;
          }
          navigator.clipboard.writeText(dashboardToken).then(() => {
            alert('Token copied to clipboard!');
          });
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
          fetchToken();
        });
      </script>
    </body>
    </html>

---
# Nginx config for token service
apiVersion: v1
kind: ConfigMap
metadata:
  name: dashboard-nginx-config
  namespace: kubernetes-dashboard
data:
  default.conf: |
    server {
      listen 8080;
      server_name _;
      
      location /api/token {
        default_type application/json;
        return 200 '{"token":""}';
      }
      
      location / {
        root /usr/share/nginx/html;
        index index.html;
      }
    }


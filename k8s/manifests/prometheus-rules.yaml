---
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-rules
  namespace: fks-trading
  labels:
    app: prometheus
    component: monitoring
data:
  execution_alerts.yml: |
    groups:
      - name: execution_pipeline
        interval: 30s
        rules:
          # ====================================================================
          # Webhook Alerts
          # ====================================================================

          - alert: HighWebhookLatency
            expr: histogram_quantile(0.95, rate(execution_webhook_processing_duration_seconds_bucket[5m])) > 0.1
            for: 5m
            labels:
              severity: warning
              category: performance
            annotations:
              summary: "High webhook processing latency"
              description: "95th percentile webhook latency is {{ $value | humanizeDuration }}, exceeding 100ms threshold."
              recommended_action: "1. Check webhook handler performance\n2. Review validation logic\n3. Monitor database query time\n4. Consider caching"

          - alert: WebhookValidationFailureRate
            expr: rate(execution_webhook_validation_failures_total[5m]) / rate(execution_webhook_requests_total[5m]) > 0.1
            for: 3m
            labels:
              severity: warning
              category: data_quality
            annotations:
              summary: "High webhook validation failure rate"
              description: "{{ $value | humanizePercentage }} of webhooks are failing validation for {{ $labels.source }}."
              recommended_action: "1. Check TradingView alert configuration\n2. Review webhook payload schema\n3. Validate required fields\n4. Check for malformed JSON"

          - alert: WebhookSignatureFailures
            expr: rate(execution_webhook_signature_failures_total[5m]) > 0
            for: 1m
            labels:
              severity: critical
              category: security
            annotations:
              summary: "Webhook signature verification failures detected"
              description: "{{ $value }} signature verification failures per second from {{ $labels.source }}."
              recommended_action: "1. Verify webhook secret matches TradingView\n2. Check for replay attacks\n3. Review client IP\n4. Investigate potential security breach"

          # ====================================================================
          # Order Execution Alerts
          # ====================================================================

          - alert: HighOrderFailureRate
            expr: rate(execution_order_failures_total[5m]) / rate(execution_orders_total[5m]) > 0.1
            for: 5m
            labels:
              severity: critical
              category: trading
            annotations:
              summary: "High order failure rate on {{ $labels.exchange }}"
              description: "{{ $value | humanizePercentage }} of orders are failing on {{ $labels.exchange }}."
              recommended_action: "1. Check exchange API status\n2. Verify API keys\n3. Review order parameters\n4. Check account balance\n5. Monitor exchange maintenance"

          - alert: CircuitBreakerOpened
            expr: execution_circuit_breaker_state{state="open"} == 1
            for: 1m
            labels:
              severity: critical
              category: availability
            annotations:
              summary: "Circuit breaker opened for {{ $labels.exchange }}"
              description: "Circuit breaker is OPEN for {{ $labels.exchange }}, preventing order execution."
              recommended_action: "1. Investigate recent exchange errors\n2. Check network connectivity\n3. Verify exchange status page\n4. Wait for auto-recovery or manually reset"

          # ====================================================================
          # Security Alerts
          # ====================================================================

          - alert: HighRateLimitRejections
            expr: rate(execution_rate_limit_rejections_total[5m]) > 100
            for: 5m
            labels:
              severity: warning
              category: security
            annotations:
              summary: "High rate of rate limit rejections"
              description: "{{ $value }} requests/sec are being rate limited from {{ $labels.identifier }}."
              recommended_action: "1. Investigate source IP\n2. Check for DDoS attack\n3. Review rate limit configuration\n4. Consider IP blocking"

          - alert: IPWhitelistRejections
            expr: rate(execution_ip_whitelist_rejections_total[5m]) > 50
            for: 5m
            labels:
              severity: warning
              category: security
            annotations:
              summary: "High rate of IP whitelist rejections"
              description: "{{ $value }} requests/sec are being rejected by IP whitelist."
              recommended_action: "1. Review rejected IP addresses\n2. Update whitelist if legitimate\n3. Investigate potential attacks\n4. Check firewall rules"

          # ====================================================================
          # Data Quality Alerts
          # ====================================================================

          - alert: HighNaNReplacementRate
            expr: rate(execution_nan_replacements_total[5m]) > 10
            for: 5m
            labels:
              severity: info
              category: data_quality
            annotations:
              summary: "High rate of NaN value replacements"
              description: "{{ $value }} NaN values/sec detected in {{ $labels.field }}."
              recommended_action: "1. Investigate data source\n2. Review data validation\n3. Check upstream services\n4. Monitor data pipeline health"

          # ====================================================================
          # Exchange Health Alerts
          # ====================================================================

          - alert: HighExchangeAPILatency
            expr: rate(execution_exchange_api_calls_duration_seconds_sum[5m]) / rate(execution_exchange_api_calls_duration_seconds_count[5m]) > 1
            for: 5m
            labels:
              severity: warning
              category: performance
            annotations:
              summary: "High API latency for {{ $labels.exchange }}"
              description: "Average API latency is {{ $value | humanizeDuration }} for {{ $labels.exchange }}."
              recommended_action: "1. Check exchange status page\n2. Monitor network connectivity\n3. Review API endpoint performance\n4. Consider failover to backup exchange"

          - alert: ExchangeConnectionLoss
            expr: execution_exchange_connections == 0
            for: 2m
            labels:
              severity: critical
              category: availability
            annotations:
              summary: "No active exchange connections"
              description: "All exchange connections are down."
              recommended_action: "1. Check network connectivity\n2. Verify exchange API status\n3. Review API credentials\n4. Restart execution service if needed"

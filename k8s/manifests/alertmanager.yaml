---
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: fks-trading
  labels:
    app: alertmanager
    component: monitoring
data:
  alertmanager.yml: |
    global:
      resolve_timeout: 5m
      slack_api_url_file: /etc/alertmanager/secrets/slack-webhook-url
    
    # Templates for notifications
    templates:
      - '/etc/alertmanager/templates/*.tmpl'
    
    # Routing tree
    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 12h
      receiver: 'slack-critical'
      
      routes:
        # Critical alerts go to Slack immediately
        - match:
            severity: critical
          receiver: slack-critical
          continue: true
        
        # Warning alerts grouped and sent less frequently
        - match:
            severity: warning
          receiver: slack-warnings
          group_wait: 30s
          group_interval: 5m
          repeat_interval: 4h
        
        # Info alerts sent to a separate channel
        - match:
            severity: info
          receiver: slack-info
          group_wait: 1m
          group_interval: 10m
          repeat_interval: 24h
    
    # Inhibition rules
    inhibit_rules:
      # Inhibit warning if critical is firing for same alert
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'exchange', 'service']
    
    # Receivers
    receivers:
      - name: 'slack-critical'
        slack_configs:
          - channel: '#fks-alerts-critical'
            title: 'ðŸš¨ CRITICAL: {{ .GroupLabels.alertname }}'
            text: >-
              {{ range .Alerts }}
                *Alert:* {{ .Annotations.summary }}
                *Description:* {{ .Annotations.description }}
                *Severity:* {{ .Labels.severity }}
                *Service:* {{ .Labels.service }}
                *Exchange:* {{ .Labels.exchange }}
                *Action:* {{ .Annotations.recommended_action }}
                *Started:* {{ .StartsAt }}
              {{ end }}
            send_resolved: true
            color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
      
      - name: 'slack-warnings'
        slack_configs:
          - channel: '#fks-alerts-warnings'
            title: 'âš ï¸ WARNING: {{ .GroupLabels.alertname }}'
            text: >-
              {{ range .Alerts }}
                *Alert:* {{ .Annotations.summary }}
                *Description:* {{ .Annotations.description }}
                *Service:* {{ .Labels.service }}
                *Action:* {{ .Annotations.recommended_action }}
              {{ end }}
            send_resolved: true
            color: 'warning'
      
      - name: 'slack-info'
        slack_configs:
          - channel: '#fks-alerts-info'
            title: 'â„¹ï¸ INFO: {{ .GroupLabels.alertname }}'
            text: >-
              {{ range .Alerts }}
                *Alert:* {{ .Annotations.summary }}
                *Description:* {{ .Annotations.description }}
              {{ end }}
            send_resolved: false
            color: '#439FE0'

---
apiVersion: v1
kind: Service
metadata:
  name: alertmanager
  namespace: fks-trading
  labels:
    app: alertmanager
    component: monitoring
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 9093
      targetPort: 9093
      protocol: TCP
  selector:
    app: alertmanager

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: alertmanager
  namespace: fks-trading
  labels:
    app: alertmanager
    component: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: alertmanager
  template:
    metadata:
      labels:
        app: alertmanager
        component: monitoring
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
        fsGroup: 65534
      containers:
      - name: alertmanager
        image: prom/alertmanager:latest
        args:
          - '--config.file=/etc/alertmanager/alertmanager.yml'
          - '--storage.path=/alertmanager'
          - '--web.external-url=https://alertmanager.fks-trading.com'
        ports:
        - name: http
          containerPort: 9093
          protocol: TCP
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 200m
            memory: 256Mi
        volumeMounts:
        - name: config
          mountPath: /etc/alertmanager
        - name: secrets
          mountPath: /etc/alertmanager/secrets
          readOnly: true
        - name: data
          mountPath: /alertmanager
        livenessProbe:
          httpGet:
            path: /-/healthy
            port: 9093
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /-/ready
            port: 9093
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: config
        configMap:
          name: alertmanager-config
      - name: secrets
        secret:
          secretName: fks-secrets
          items:
            - key: slack-webhook-url
              path: slack-webhook-url
      - name: data
        emptyDir: {}

{{- if and .Values.prometheus.enabled (hasKey .Values "monitoring") (hasKey .Values.monitoring "prometheusRules") .Values.monitoring.prometheusRules.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: fks-platform-alerts
  namespace: {{ .Release.Namespace }}
  labels:
    app: fks-platform
    prometheus: kube-prometheus
spec:
  groups:
  - name: fks_platform_alerts
    interval: 30s
    rules:
    
    # High CPU usage
    - alert: HighCPUUsage
      expr: |
        sum(rate(container_cpu_usage_seconds_total{namespace="{{ .Release.Namespace }}"}[5m])) by (pod) > 0.8
      for: 5m
      labels:
        severity: warning
        component: compute
      annotations:
        summary: "High CPU usage on {{ "{{" }} $labels.pod {{ "}}" }}"
        description: "Pod {{ "{{" }} $labels.pod {{ "}}" }} CPU usage is above 80% for 5 minutes"
    
    # High memory usage
    - alert: HighMemoryUsage
      expr: |
        sum(container_memory_working_set_bytes{namespace="{{ .Release.Namespace }}"}) by (pod) / 
        sum(container_spec_memory_limit_bytes{namespace="{{ .Release.Namespace }}"}) by (pod) > 0.9
      for: 5m
      labels:
        severity: warning
        component: memory
      annotations:
        summary: "High memory usage on {{ "{{" }} $labels.pod {{ "}}" }}"
        description: "Pod {{ "{{" }} $labels.pod {{ "}}" }} memory usage is above 90%"
    
    # Pod restart rate
    - alert: HighPodRestartRate
      expr: |
        rate(kube_pod_container_status_restarts_total{namespace="{{ .Release.Namespace }}"}[15m]) > 0.1
      for: 5m
      labels:
        severity: critical
        component: stability
      annotations:
        summary: "High restart rate for {{ "{{" }} $labels.pod {{ "}}" }}"
        description: "Pod {{ "{{" }} $labels.pod {{ "}}" }} is restarting frequently"
    
    # Service down
    - alert: ServiceDown
      expr: |
        up{namespace="{{ .Release.Namespace }}"} == 0
      for: 2m
      labels:
        severity: critical
        component: availability
      annotations:
        summary: "Service {{ "{{" }} $labels.job {{ "}}" }} is down"
        description: "Service has been down for more than 2 minutes"
    
    # Database connection failures
    - alert: DatabaseConnectionFailures
      expr: |
        rate(postgresql_connection_errors_total[5m]) > 0.1
      for: 3m
      labels:
        severity: critical
        component: database
      annotations:
        summary: "PostgreSQL connection failures detected"
        description: "Database connection error rate is high"
    
    # Redis connection failures
    - alert: RedisConnectionFailures
      expr: |
        rate(redis_connection_errors_total[5m]) > 0.1
      for: 3m
      labels:
        severity: warning
        component: cache
      annotations:
        summary: "Redis connection failures detected"
        description: "Redis connection error rate is high"
    
    # API latency
    - alert: HighAPILatency
      expr: |
        histogram_quantile(0.95, 
          sum(rate(http_request_duration_seconds_bucket{namespace="{{ .Release.Namespace }}"}[5m])) by (le, service)
        ) > 0.5
      for: 5m
      labels:
        severity: warning
        component: performance
      annotations:
        summary: "High API latency on {{ "{{" }} $labels.service {{ "}}" }}"
        description: "95th percentile latency is above 500ms"
    
    # Error rate
    - alert: HighErrorRate
      expr: |
        sum(rate(http_requests_total{namespace="{{ .Release.Namespace }}", status=~"5.."}[5m])) by (service) /
        sum(rate(http_requests_total{namespace="{{ .Release.Namespace }}"}[5m])) by (service) > 0.05
      for: 3m
      labels:
        severity: critical
        component: reliability
      annotations:
        summary: "High error rate on {{ "{{" }} $labels.service {{ "}}" }}"
        description: "Error rate is above 5% for 3 minutes"
    
    # Disk usage
    - alert: HighDiskUsage
      expr: |
        (1 - (node_filesystem_avail_bytes{mountpoint="/", namespace="{{ .Release.Namespace }}"} / 
        node_filesystem_size_bytes{mountpoint="/", namespace="{{ .Release.Namespace }}"})) > 0.85
      for: 5m
      labels:
        severity: warning
        component: storage
      annotations:
        summary: "High disk usage on {{ "{{" }} $labels.instance {{ "}}" }}"
        description: "Disk usage is above 85%"
    
    # AI inference queue depth
    - alert: HighAIQueueDepth
      expr: |
        inference_queue_depth{service="fks-ai"} > 100
      for: 5m
      labels:
        severity: warning
        component: ai
      annotations:
        summary: "High AI inference queue depth"
        description: "AI service has {{ "{{" }} $value {{ "}}" }} pending inference requests"
    
    # Trading execution lag
    - alert: HighExecutionLag
      expr: |
        execution_lag_seconds{service="fks-execution"} > 1.0
      for: 2m
      labels:
        severity: critical
        component: trading
      annotations:
        summary: "High execution lag detected"
        description: "Execution lag is {{ "{{" }} $value {{ "}}" }} seconds (> 1s)"
{{- end }}

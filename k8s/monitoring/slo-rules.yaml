# Prometheus SLO Recording Rules
# These rules calculate SLO metrics for each service

groups:
  - name: fks_slos
    interval: 30s
    rules:

      # fks_api SLO Metrics
      - record: fks_api:availability:ratio
        expr: |
          sum(rate(http_requests_total{service="fks_api",status!~"5.."}[5m]))
          /
          sum(rate(http_requests_total{service="fks_api"}[5m]))
      
      - record: fks_api:error_rate:ratio
        expr: |
          sum(rate(http_requests_total{service="fks_api",status=~"5.."}[5m]))
          /
          sum(rate(http_requests_total{service="fks_api"}[5m]))
      
      - record: fks_api:latency:p95
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service="fks_api"}[5m])) by (le))
      
      - record: fks_api:error_budget:remaining
        expr: |
          (0.1 - (fks_api:error_rate:ratio)) / 0.1

      # fks_monitor SLO Metrics
      - record: fks_monitor:availability:ratio
        expr: |
          sum(rate(http_requests_total{service="fks_monitor",status!~"5.."}[5m]))
          /
          sum(rate(http_requests_total{service="fks_monitor"}[5m]))
      
      - record: fks_monitor:error_rate:ratio
        expr: |
          sum(rate(http_requests_total{service="fks_monitor",status=~"5.."}[5m]))
          /
          sum(rate(http_requests_total{service="fks_monitor"}[5m]))
      
      - record: fks_monitor:latency:p95
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service="fks_monitor"}[5m])) by (le))
      
      - record: fks_monitor:error_budget:remaining
        expr: |
          (0.05 - (fks_monitor:error_rate:ratio)) / 0.05

      # fks_main SLO Metrics
      - record: fks_main:availability:ratio
        expr: |
          sum(rate(http_requests_total{service="fks_main",status!~"5.."}[5m]))
          /
          sum(rate(http_requests_total{service="fks_main"}[5m]))
      
      - record: fks_main:error_rate:ratio
        expr: |
          sum(rate(http_requests_total{service="fks_main",status=~"5.."}[5m]))
          /
          sum(rate(http_requests_total{service="fks_main"}[5m]))
      
      - record: fks_main:latency:p95
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service="fks_main"}[5m])) by (le))
      
      - record: fks_main:error_budget:remaining
        expr: |
          (0.1 - (fks_main:error_rate:ratio)) / 0.1

      # fks_data SLO Metrics
      - record: fks_data:availability:ratio
        expr: |
          sum(rate(http_requests_total{service="fks_data",status!~"5.."}[5m]))
          /
          sum(rate(http_requests_total{service="fks_data"}[5m]))
      
      - record: fks_data:error_rate:ratio
        expr: |
          sum(rate(http_requests_total{service="fks_data",status=~"5.."}[5m]))
          /
          sum(rate(http_requests_total{service="fks_data"}[5m]))
      
      - record: fks_data:latency:p95
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service="fks_data"}[5m])) by (le))
      
      - record: fks_data:error_budget:remaining
        expr: |
          (0.5 - (fks_data:error_rate:ratio)) / 0.5

      # fks_execution SLO Metrics
      - record: fks_execution:availability:ratio
        expr: |
          sum(rate(http_requests_total{service="fks_execution",status!~"5.."}[5m]))
          /
          sum(rate(http_requests_total{service="fks_execution"}[5m]))
      
      - record: fks_execution:error_rate:ratio
        expr: |
          sum(rate(http_requests_total{service="fks_execution",status=~"5.."}[5m]))
          /
          sum(rate(http_requests_total{service="fks_execution"}[5m]))
      
      - record: fks_execution:latency:p95
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service="fks_execution"}[5m])) by (le))
      
      - record: fks_execution:error_budget:remaining
        expr: |
          (0.2 - (fks_execution:error_rate:ratio)) / 0.2

      # fks_web SLO Metrics
      - record: fks_web:availability:ratio
        expr: |
          sum(rate(http_requests_total{service="fks_web",status!~"5.."}[5m]))
          /
          sum(rate(http_requests_total{service="fks_web"}[5m]))
      
      - record: fks_web:error_rate:ratio
        expr: |
          sum(rate(http_requests_total{service="fks_web",status=~"5.."}[5m]))
          /
          sum(rate(http_requests_total{service="fks_web"}[5m]))
      
      - record: fks_web:latency:p95
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service="fks_web"}[5m])) by (le))
      
      - record: fks_web:error_budget:remaining
        expr: |
          (0.5 - (fks_web:error_rate:ratio)) / 0.5

      # fks_ai SLO Metrics
      - record: fks_ai:availability:ratio
        expr: |
          sum(rate(http_requests_total{service="fks_ai",status!~"5.."}[5m]))
          /
          sum(rate(http_requests_total{service="fks_ai"}[5m]))
      
      - record: fks_ai:error_rate:ratio
        expr: |
          sum(rate(http_requests_total{service="fks_ai",status=~"5.."}[5m]))
          /
          sum(rate(http_requests_total{service="fks_ai"}[5m]))
      
      - record: fks_ai:latency:p95
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service="fks_ai"}[5m])) by (le))
      
      - record: fks_ai:error_budget:remaining
        expr: |
          (1.0 - (fks_ai:error_rate:ratio)) / 1.0

      # fks_analyze SLO Metrics
      - record: fks_analyze:availability:ratio
        expr: |
          sum(rate(http_requests_total{service="fks_analyze",status!~"5.."}[5m]))
          /
          sum(rate(http_requests_total{service="fks_analyze"}[5m]))
      
      - record: fks_analyze:error_rate:ratio
        expr: |
          sum(rate(http_requests_total{service="fks_analyze",status=~"5.."}[5m]))
          /
          sum(rate(http_requests_total{service="fks_analyze"}[5m]))
      
      - record: fks_analyze:latency:p95
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service="fks_analyze"}[5m])) by (le))
      
      - record: fks_analyze:error_budget:remaining
        expr: |
          (1.0 - (fks_analyze:error_rate:ratio)) / 1.0
